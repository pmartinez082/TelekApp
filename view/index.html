<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bot telekil</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <h1>Bot Telekil</h1>
    <p>Irati por favor no pongas cosas de furrys</p>
    <p style= "color: red">Es bromi, eres libre, ya lo dec√≠a el michael laboa</p>
    <div style="display: block;" id="urkullu">
        <h1 id = "pitxon"> Urkullupitxon, identif√≠cate</h1>
        <form id="login-form">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password">
            <button id="nerd" type="submit">por cada login, +10 puntos de nerd</button>
            <img src = "nerd.gif" alt="Nerd" width="100px" height="100px">
        </form>
    </div>
    
    <div id="main-content" style="display: none;">
    <button id ="logout">get me out of here</button><button id="register">new erabiltzaile</button>
    <img src="angery-admin.png" style="width: 200px;"></img>
        <form id="autoresponse-form">
            <label for="trigger">Mensajite:</label>
            <input type="text" id="trigger" name="trigger">
            <label for="autoresponse">Respueste:</label>
            <input type="text" id="autoresponse" name="autoresponse">
            <button type="submit">Bidali</button>
        </form>

    <div>
        <h2>Respuestas disponibles</h2>
        <ul id="combos"></ul>
            

    </div>
    </div>
   
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/core.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js"></script>
<script>
    const token = localStorage.getItem("token-telekapp") || null;
    const apiUrl =  window.location.origin + "/TelekApp/";
(async function init() {
  

    if (await checkToken(token)) {
        await getCombos(token);

        document.getElementById("logout").addEventListener("click", async function(event) {
            localStorage.removeItem("token-telekapp");
            event.preventDefault();
            window.location.reload();
        });

        document.getElementById("autoresponse-form").addEventListener("submit", async function(event) {
            event.preventDefault();
            const trigger = document.querySelector("#trigger").value;
            const autoresponse = document.querySelector("#autoresponse").value;

            try {
                const response = await fetch(apiUrl + "discordbotapi", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        trigger: trigger,
                        autoresponse: autoresponse
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                console.log("Created combo:", data);
                window.location.reload();

            } catch (error) {
                console.error("Error creating combo:", error);
            }
        });

    } else {
        document.getElementById("login-form").addEventListener("submit", async function(event) {
            event.preventDefault();
            await login();
        });
    }
})();
    
document.getElementById("register").addEventListener("click", async function(event) {
    // erakutsi login form-a, baina ez egin submit-etik login, baizik eta register funtzioa exekutatu
    document.getElementById("login-form").style.display = "block";
    document.getElementById("register").style.display = "none";
    document.getElementById("main-content").style.display = "none";
    document.getElementById("urkullu").style.display = "block";
    document.getElementById("nerd").innerText = "registra a otro nerd";
    document.getElementById("pitxon").innerText = "Urkullupitxon, registra a otro nerd";
    document.getElementById("login-form").removeEventListener("submit", login);
    
    document.getElementById("login-form").addEventListener("submit", async function(event) {

        event.preventDefault();
       
        await register();
       
    });
   
});

async function register(){
    const username = document.querySelector("#username").value;
    const password = document.querySelector("#password").value;
    const password_hash = CryptoJS.MD5(password).toString();

    try {
        const response = await fetch(apiUrl + "register", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
                username_reg: username,
                password_hash_reg: password_hash
            })
        });

        if (!response.ok) {
            throw new Error(`Login failed! status: ${response.status}`);
        }

        const data = await response.json();

        localStorage.removeItem("token-telekapp");
        window.location.reload();

    }
    catch (error) {
       alert("Error registrando, sorry xxxxxxxxxxxxxxxxxxxxxxxxxxx");
       
    }
}

    
async function checkToken(token) {
    const mainContent = document.getElementById("main-content");
    const urkullu = document.getElementById("urkullu");

    if (!token) {
        mainContent.style.display = "none";
        urkullu.style.display = "block";
        return false;
    }

    try {
        const response = await fetch(apiUrl + "check_token", {
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.valid) {
            mainContent.style.display = "block";
            urkullu.style.display = "none";
            return true;
        } else {
            mainContent.style.display = "none";
            urkullu.style.display = "block";
            return false;
        }

    } catch (error) {
        console.error(error);
        mainContent.style.display = "none";
        urkullu.style.display = "block";
        return false;
    }
}




// Fetch and display combos
async function getCombos(token) {
    const combos = document.getElementById("combos");

    try {
        const response = await fetch(apiUrl + "autoresponse", {
            headers: {
                "Authorization": `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        combos.innerHTML = "";
        data.forEach(combo => {
            const p = document.createElement("p");
            p.style.fontWeight = "bold";
            p.innerText = combo.trigger;
            combos.appendChild(p);
combo.responses.forEach(response => {
    const li = document.createElement("li");

    // Display the response (image or text)
    if (response.endsWith(".png") || response.endsWith(".jpg") || response.endsWith(".jpeg") || response.startsWith("http") || response.endsWith(".gif") || response.endsWith(".mp4")) {
        const img = document.createElement("img");
        img.src = response;
        img.alt = response;
        img.style.maxWidth = "200px";
        li.appendChild(img);
    } else {
        const span = document.createElement("span");
        span.className = "response-text";
        span.innerText = response;
        li.appendChild(span);
    }

    // Add delete button
    const deleteButton = document.createElement("button");
    deleteButton.className = "delete-btn";
    deleteButton.innerText = "üí• Suntsiketa üóëÔ∏è";


    // Add click event to delete button
    deleteButton.addEventListener("click", async () => {
        try {
            const deleteResponse = await fetch(apiUrl + "autoresponse/delete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    trigger: combo.trigger,
                    response: response
                })
            });

            if (!deleteResponse.ok) {
                throw new Error(`Failed to delete response! status: ${deleteResponse.status}`);
            }

            // Refresh the combos list
            await getCombos(token);
        } catch (error) {
            console.error("Error deleting response:", error);
            alert("Failed to delete response.");
        }
    });

    li.appendChild(deleteButton);
    combos.appendChild(li);
});
           
           
        });

    } catch (error) {
        console.error("Error fetching combos:", error);
        combos.innerHTML = "<li>Failed to load combos</li>";
    }
}

// Login function
async function login() {
    console.log("Attempting login...");
    const username = document.querySelector("#username").value;
    const password = document.querySelector("#password").value;
    const password_hash = CryptoJS.MD5(password).toString();

    try {
        const response = await fetch(apiUrl + "login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                username: username,
                password_hash: password_hash
            })
        });
        console.log(apiUrl + "login");

        if (!response.ok) {
            throw new Error(`Login failed! status: ${response.status}`);
        }

        const data = await response.json();

        console.log("Login response:", data);
        // Save token to localStorage
        localStorage.setItem("token-telekapp", data.access_token);

        // Reload the page after login
        window.location.reload();

    } catch (error) {
        console.error("Error during login:", error);
        alert("Login failed, please check your credentials.");
    }
}

</script>
</html>